<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Introduction In the previous article &ldquo;Getting Fancy with Rust and WebAssembly (Part 3) - DOM Manipulation and Type Conversion&rdquo;, we discussed the interaction between Rust and JS, including mutual function calls between Rust and JS. A particularly mind-blowing feature was using JS to call Rust structs. JS itself doesn&rsquo;t even have structs, yet it can call Rust structs. This is really great for the development experience of Rust developers!\nBased on the previous series of articles, it&rsquo;s already sufficient to develop a complete functionality using Rust.\n"><title>Getting Fancy with Rust and WebAssembly (Part 4) - Smaller wasm file size</title><link rel=canonical href=https://hunterji.com/posts/getting-fancy-with-rust-and-webassembly-part-4-smaller-wasm-file-size/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="Getting Fancy with Rust and WebAssembly (Part 4) - Smaller wasm file size"><meta property='og:description' content="Introduction In the previous article &ldquo;Getting Fancy with Rust and WebAssembly (Part 3) - DOM Manipulation and Type Conversion&rdquo;, we discussed the interaction between Rust and JS, including mutual function calls between Rust and JS. A particularly mind-blowing feature was using JS to call Rust structs. JS itself doesn&rsquo;t even have structs, yet it can call Rust structs. This is really great for the development experience of Rust developers!\nBased on the previous series of articles, it&rsquo;s already sufficient to develop a complete functionality using Rust.\n"><meta property='og:url' content='https://hunterji.com/posts/getting-fancy-with-rust-and-webassembly-part-4-smaller-wasm-file-size/'><meta property='og:site_name' content='Hunter Ji'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='WebAssembly'><meta property='article:tag' content='Rust'><meta property='article:published_time' content='2023-10-27T00:00:00+00:00'><meta property='article:modified_time' content='2023-10-27T00:00:00+00:00'><meta property='og:image' content='https://hunterji.com/posts/getting-fancy-with-rust-and-webassembly-part-4-smaller-wasm-file-size/cover.jpg'><meta name=twitter:title content="Getting Fancy with Rust and WebAssembly (Part 4) - Smaller wasm file size"><meta name=twitter:description content="Introduction In the previous article &ldquo;Getting Fancy with Rust and WebAssembly (Part 3) - DOM Manipulation and Type Conversion&rdquo;, we discussed the interaction between Rust and JS, including mutual function calls between Rust and JS. A particularly mind-blowing feature was using JS to call Rust structs. JS itself doesn&rsquo;t even have structs, yet it can call Rust structs. This is really great for the development experience of Rust developers!\nBased on the previous series of articles, it&rsquo;s already sufficient to develop a complete functionality using Rust.\n"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://hunterji.com/posts/getting-fancy-with-rust-and-webassembly-part-4-smaller-wasm-file-size/cover.jpg'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu13765127513111647749.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ðŸ¥¤</span></figure><div class=site-meta><h1 class=site-name><a href=/>Hunter Ji</a></h1><h2 class=site-description>Developer Ã— Design Learner</h2></div></header><ol class=menu-social><li><a href=https://github.com/hunter-ji target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank title=Instagram rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-instagram"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 8a4 4 0 014-4h8a4 4 0 014 4v8a4 4 0 01-4 4H8a4 4 0 01-4-4z"/><path d="M9 12a3 3 0 106 0 3 3 0 00-6 0"/><path d="M16.5 7.5v.01"/></svg></a></li><li><a href=https://www.reddit.com/user/Careless_Tomorrow127/ target=_blank title=Reddit rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-reddit"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 8c2.648.0 5.028.826 6.675 2.14a2.5 2.5.0 012.326 4.36c0 3.59-4.03 6.5-9 6.5-4.875.0-8.845-2.8-9-6.294l-1-.206a2.5 2.5.0 012.326-4.36C5.973 8.827 8.353 8 11.001 8z"/><path d="M12 8l1-5 6 1"/><path d="M19 4m-1 0a1 1 0 102 0 1 1 0 10-2 0"/><circle cx="9" cy="13" r=".5" fill="currentcolor"/><circle cx="15" cy="13" r=".5" fill="currentcolor"/><path d="M10 17c.667.333 1.333.5 2 .5s1.333-.167 2-.5"/></svg></a></li><li><a href='https://x.com/intent/follow?screen_name=hi_hunterji' target=_blank title=X rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-x"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4l11.733 16H20L8.267 4z"/><path d="M4 20l6.768-6.768m2.46-2.46L20 4"/></svg></a></li><li><a href=https://www.youtube.com/@HiHunterJi target=_blank title=YouTube rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-youtube"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M2 8a4 4 0 014-4h12a4 4 0 014 4v8a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><path d="M10 9l5 3-5 3z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://hunterji.com/ selected>English</option><option value=https://hunterji.com/zh-cn/>ç®€ä½“ä¸­æ–‡</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#introduction>Introduction</a></li><li><a href=#environment>Environment</a></li><li><a href=#checking-the-size>Checking the Size</a><ol><li><ol><li><a href=#ls>ls</a></li><li><a href=#stat>stat</a></li><li><a href=#wc>wc</a></li></ol></li></ol></li><li><a href=#iv-code-level>IV. Code Level</a><ol><li><a href=#1-within-the-code>1. Within the Code</a></li><li><a href=#2-outside-the-code>2. Outside the Code</a></li></ol></li><li><a href=#network-level>Network Level</a><ol><li><a href=#1-enabling-gzip>1. Enabling GZIP</a></li><li><a href=#2-server-support>2. Server Support</a></li></ol></li><li><a href=#physical-level>Physical Level</a><ol><li><a href=#1-physical-compression>1. Physical Compression</a></li><li><a href=#2-physical-decompression>2. Physical Decompression</a></li></ol></li><li><a href=#buff-stacking>BUFF Stacking</a></li><li><a href=#conclusion>Conclusion</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/getting-fancy-with-rust-and-webassembly-part-4-smaller-wasm-file-size/><img src=/posts/getting-fancy-with-rust-and-webassembly-part-4-smaller-wasm-file-size/cover_hu3971527518416831236.jpg srcset="/posts/getting-fancy-with-rust-and-webassembly-part-4-smaller-wasm-file-size/cover_hu3971527518416831236.jpg 800w, /posts/getting-fancy-with-rust-and-webassembly-part-4-smaller-wasm-file-size/cover_hu15167486291861407916.jpg 1600w" width=800 height=526 loading=lazy alt="Featured image of post Getting Fancy with Rust and WebAssembly (Part 4) - Smaller wasm file size"></a></div><div class=article-details><header class=article-category><a href=/categories/develop/ style=background-color:#303030;color:#fff>Develop</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/getting-fancy-with-rust-and-webassembly-part-4-smaller-wasm-file-size/>Getting Fancy with Rust and WebAssembly (Part 4) - Smaller wasm file size</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Oct 27, 2023</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>9 minute read</time></div></footer><footer class=article-translations><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://hunterji.com/zh-cn/posts/%E4%BD%BF%E7%94%A8rust%E5%92%8Cwebassembly%E6%95%B4%E8%8A%B1%E6%B4%BB%E5%84%BF%E5%9B%9B%E6%9B%B4%E5%B0%8F%E6%9B%B4%E5%B0%8F%E7%9A%84wasm%E6%96%87%E4%BB%B6%E4%BD%93%E7%A7%AF/ class=link>ç®€ä½“ä¸­æ–‡</a></div></footer></div></header><section class=article-content><h2 id=introduction>Introduction</h2><p>In the previous article <a class=link href=https://hunterji.com/blog/getting-fancy-with-rust-and-webAssembly-3 target=_blank rel=noopener>&ldquo;Getting Fancy with Rust and WebAssembly (Part 3) - DOM Manipulation and Type Conversion&rdquo;</a>, we discussed the interaction between Rust and JS, including mutual function calls between Rust and JS. A particularly mind-blowing feature was using JS to call Rust structs. JS itself doesn&rsquo;t even have structs, yet it can call Rust structs. This is really great for the development experience of Rust developers!</p><p>Based on the previous series of articles, it&rsquo;s already sufficient to develop a complete functionality using Rust.</p><p>However, when importing wasm files in the frontend, there may still be some issues, such as large wasm files leading to longer webpage loading times and poor user experience. This article will explore various ways to reduce the size of Rust-compiled wasm files, thereby reducing the time it takes for the frontend to load wasm files.</p><p>For a while, I was using Go to develop WebAssembly, and the compiled wasm files were quite large. It was really painstaking to reduce the size of wasm files, and 1xMB size wasm files were really painful&mldr;&mldr; But size optimization often points to a &ldquo;seductive point of no return&rdquo; - switching to Rust development ðŸ˜†! If you&rsquo;re already using Rust to develop WebAssembly, congratulations, you&rsquo;re already winning at the starting line in terms of wasm size compared to Go.</p><h2 id=environment>Environment</h2><ul><li>Rust 1.70.0</li><li>wasm-bindgen 0.2.87</li></ul><h2 id=checking-the-size>Checking the Size</h2><p>Before actually reducing the size, we need to first look at what the current size is, to facilitate later comparison of before and after sizes.</p><p>There are multiple ways to check the size, here are a few recommendations (for Linux and MacOS), you can use any one of them.</p><h4 id=ls>ls</h4><p>You can use <code>ls -l</code> or <code>ll</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ll pkg/hello_wasm_bg.wasm
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> hunter  staff    23K Jul <span class=m>20</span> 21:52 pkg/hello_wasm_bg.wasm
</span></span></code></pre></td></tr></table></div></div><h4 id=stat>stat</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ stat pkg/hello_wasm_bg.wasm
</span></span><span class=line><span class=cl><span class=m>16777222</span> <span class=m>142141572</span> -rw-r--r-- <span class=m>1</span> hunter staff <span class=m>0</span> <span class=m>23347</span> <span class=s2>&#34;Jul 20 21:52:53 2023&#34;</span> <span class=s2>&#34;Jul 20 21:52:01 2023&#34;</span> <span class=s2>&#34;Jul 20 21:52:01 2023&#34;</span> <span class=s2>&#34;Jul 20 21:52:01 2023&#34;</span> <span class=m>4096</span> <span class=m>48</span> <span class=m>0</span> pkg/hello_wasm_bg.wasm
</span></span></code></pre></td></tr></table></div></div><h4 id=wc>wc</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ wc -c pkg/hello_wasm_bg.wasm
</span></span><span class=line><span class=cl>   <span class=m>23347</span> pkg/hello_wasm_bg.wasm
</span></span></code></pre></td></tr></table></div></div><p>Using <code>wc</code> as an example, the current wasm file size is <strong>23347b</strong>.</p><h2 id=iv-code-level>IV. Code Level</h2><blockquote><p>Link-Time Optimization (LTO) refers to a type of interprocedural optimization performed during program linking. It allows the compiler to optimize across multiple compilation units during the linking phase, thereby improving the program&rsquo;s performance, reliability, and security.</p></blockquote><p>Optimization at the code level mainly utilizes LTO (Link-Time Optimization).</p><h3 id=1-within-the-code>1. Within the Code</h3><p>Enable LTO in <code>Cargo.toml</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>profile</span><span class=p>.</span><span class=nx>release</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>lto</span> <span class=p>=</span> <span class=kc>true</span>
</span></span></code></pre></td></tr></table></div></div><p>Although enabling LTO can reduce the compiled size, it also increases compilation time.</p><p>After enabling LTO, by default, it ensures compilation time while reducing the compiled size to a certain extent. If your requirement is for a smaller size rather than shorter time, then you can manually specify the compilation level to make LTO change.</p><p>The following levels can be used within the code:</p><ul><li><code>s</code>: The default LTO level. It performs the most basic LTO optimizations, including function inlining, function rewriting, data rearrangement, etc.</li><li><code>z</code>: The highest LTO level. It performs more complex LTO optimizations, including dead code elimination, memory allocation optimization, security optimization, etc.</li></ul><p>So you can configure it in <code>Cargo.toml</code> like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>profile</span><span class=p>.</span><span class=nx>release</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>lto</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=nx>opt-level</span> <span class=p>=</span> <span class=s1>&#39;z&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>The original file size was 23347b, now let&rsquo;s look at the size after compilation:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ wc -c pkg/hello_wasm_bg.wasm
</span></span><span class=line><span class=cl>   <span class=m>19879</span> pkg/hello_wasm_bg.wasm
</span></span></code></pre></td></tr></table></div></div><p>It&rsquo;s clearly reduced in size! However, using the <code>z</code> level doesn&rsquo;t necessarily mean that the size will always be smaller than <code>s</code>, sometimes <code>s</code> can also be smaller than <code>z</code>, this needs to be determined based on the code situation.</p><h3 id=2-outside-the-code>2. Outside the Code</h3><p>Outside the code, you can use <a class=link href=https://github.com/WebAssembly/binaryen target=_blank rel=noopener>wasm-opt</a> for optimization. It can perform various optimizations on WebAssembly modules, of course, this article focuses on size aspects (digging a pit, we&rsquo;ll discuss in detail later /dog head). And wasm-opt can optimize all wasm files that conform to the WebAssembly specification, so even if you didn&rsquo;t write it in Rust, you can still use it for optimization. (Think about the wasm I used to write in Go, there&rsquo;s also one more way to optimize it&mldr;&mldr;)</p><p>First, let&rsquo;s look at the basic optimization parameters of wasm-opt:</p><ul><li><strong>-o</strong>: Specify the output file of the optimized module</li><li><strong>-O</strong>: Enable default optimization, equivalent to the <code>-Os</code> parameter</li><li><strong>-O0</strong>: No optimization</li><li><strong>-O1</strong>: Perform some basic optimizations, such as function inlining optimization and dead code elimination optimization</li><li><strong>-O2</strong>: Perform more thorough optimizations, such as function rewriting, data rearrangement, memory allocation optimization, etc.</li><li><strong>-O3</strong>: Perform the most thorough optimizations, including some optimizations that may affect program functionality</li><li><strong>-O4</strong>: Same as <code>-O3</code>, but will enable more aggressive optimizations</li><li><strong>-Os</strong>: The optimization goal is to reduce code size, will perform some optimizations that may affect performance</li><li><strong>-Oz</strong>: Same as <code>-Os</code>, but will enable more aggressive optimizations</li></ul><p>Based on the theme of this article, we will use the <code>-Os</code> and <code>-Oz</code> parameters here, which correspond to the levels in the above &ldquo;Within the Code&rdquo; section.</p><p>Here, let&rsquo;s execute with the <code>-Oz</code> parameter on the original wasm file, and see the comparison effect:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ wc -c pkg/output.wasm
</span></span><span class=line><span class=cl>   <span class=m>23194</span> pkg/output.wasm
</span></span></code></pre></td></tr></table></div></div><p>Then let&rsquo;s execute wasm-opt on the wasm file compiled after enabling &ldquo;Within the Code&rdquo; LTO, and see the comparison effect:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ wc -c pkg/output.wasm
</span></span><span class=line><span class=cl>   <span class=m>19871</span> pkg/output.wasm
</span></span></code></pre></td></tr></table></div></div><p>Overall, the size of the wasm file is getting smaller and smaller. It&rsquo;s just that the case I have here is using the code from the series of articles, without any actual complex code, and the size itself is already very small, so it won&rsquo;t be particularly effective.</p><h2 id=network-level>Network Level</h2><p>At the network level, it&rsquo;s the well-known compression of network transmission, where the client and server agree on the same compression algorithm, then the server compresses when sending out, and the client decompresses when receiving. Compression at the network level can compress the transmitted message without losing information.</p><p>For example, the gzip compression algorithm that everyone is familiar with, however, there are several compression algorithms:</p><ul><li>gzip</li><li>compress</li><li>deflate</li><li>br</li></ul><p>Among them, gzip also has the highest compression rate, so here we&rsquo;ll take gzip as an example.</p><p>At the network level, compress the wasm file with gzip to reduce its size during transmission. Although it reduces the size during transmission, the browser needs to consume some performance to decrypt the compressed data when it receives it.</p><h3 id=1-enabling-gzip>1. Enabling GZIP</h3><p>Enabling GZIP is actually simple, you just need to agree with the frontend and backend to both use gzip.</p><p>First, when the frontend requests the wasm file, it needs to put the compression modes supported by the browser in the request header:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span></code></pre></td></tr></table></div></div><p>Then, after the server receives this request, it can give out the compression modes that the server also supports, and tell the browser what compression mode the server will use.</p><p>The way to communicate with the browser is to put the information in the response header:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Content-Encoding: gzip
</span></span></code></pre></td></tr></table></div></div><p>This enables GZIP.</p><p>Then, the browser receives the response body and header, knows that the backend uses gzip compression, so the browser will automatically use gzip to decompress and get the complete data.</p><h3 id=2-server-support>2. Server Support</h3><p>You might wonder, the browser can automatically decrypt, but how does the server automatically encrypt? Does the backend need to write code to encrypt the file?</p><p>Of course not, just let the http server complete this operation. Here we&rsquo;ll take the familiar Nginx as an example.</p><p>The simplest is to enable gzip with one line of configuration:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>gzip on;
</span></span></code></pre></td></tr></table></div></div><p>You can also specify some parameters for gzip, such as the types that can be encrypted, the minimum encryption length, etc.:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>gzip on;
</span></span><span class=line><span class=cl>gzip_types      text/plain application/xml;
</span></span><span class=line><span class=cl>gzip_proxied    no-cache no-store private expired auth;
</span></span><span class=line><span class=cl>gzip_min_length 1000;
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p>For more http server configurations, you can refer to their respective official documentation.</p><h2 id=physical-level>Physical Level</h2><p>You might be surprised, what physical level?!</p><p>That&rsquo;s right, it&rsquo;s really at the physical level - directly perform gzip physical compression on the wasm file! Haha, this method is really amazing, I discovered it when I was looking for ways to reduce size while developing wasm with Go. If you&rsquo;ve optimized your wasm to the end of the road, you might as well boldly try this solution. ðŸ˜†</p><p>Remember in the &ldquo;Network Level&rdquo; section above, there was a question about whether manual compression is needed, well, here it&rsquo;s manual compression and decompression all the way, haha.</p><h3 id=1-physical-compression>1. Physical Compression</h3><p>First, perform physical gzip compression on the wasm file, here we&rsquo;ll use the original wasm (23347b):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gzip -c pkg/hello_wasm_bg.wasm &gt; pkg/output.gz
</span></span></code></pre></td></tr></table></div></div><p>Then, look at its size:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ wc -c pkg/output.gz
</span></span><span class=line><span class=cl>   <span class=m>10403</span> pkg/output.gz
</span></span></code></pre></td></tr></table></div></div><p>The effect is excellent, reduced from 23347b to 10403b!</p><p>Then let&rsquo;s go through the optimization of the above &ldquo;Code Level&rdquo; and see the final size:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ wc -c pkg/output.gz
</span></span><span class=line><span class=cl>    <span class=m>9237</span> pkg/output.gz
</span></span></code></pre></td></tr></table></div></div><p>The effect is even more excellent, reduced from 19871b to 9237b!</p><p>So, here we physically compress and store the wasm file, and when the browser requests, it directly requests the <code>.gz</code> file.</p><h3 id=2-physical-decompression>2. Physical Decompression</h3><p>After the browser gets the <code>.gz</code> file, it needs to physically decompress it.</p><p>Here we recommend using the frontend library <code>pako</code> to decompress the <code>.gz</code> file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>gunzipWasm</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=s2>&#34;target.gz&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>buffer</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>pako</span><span class=p>.</span><span class=nx>ungzip</span><span class=p>(</span><span class=kr>await</span> <span class=nx>res</span><span class=p>.</span><span class=nx>arrayBuffer</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=c1>// A fetched response might be decompressed twice on Firefox.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// See https://bugzilla.mozilla.org/show_bug.cgi?id=610679
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>buffer</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>===</span> <span class=mh>0x1F</span> <span class=o>&amp;&amp;</span> <span class=nx>buffer</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>===</span> <span class=mh>0x8B</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nx>buffer</span> <span class=o>=</span> <span class=nx>pako</span><span class=p>.</span><span class=nx>ungzip</span><span class=p>(</span><span class=nx>buffer</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>buffer</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Then it can be used directly.</p><h2 id=buff-stacking>BUFF Stacking</h2><p>Here we directly use all the above methods, stack the buffs directly, and see how much size we can reduce for this case (accumulated in this series of articles). In the &ldquo;Physical Level&rdquo; section, we&rsquo;ve already accumulated the buffs except for the &ldquo;Network Level&rdquo;, so we can directly use its results. And in the &ldquo;Network Level&rdquo; section, using gzip for compression, we estimate the compression rate of gzip at 40%.</p><p>Then the final wasm size of this case will be <strong>5542b</strong>, with a compression rate of about <strong>77%</strong>!</p><p>Of course, we also need to calculate an initial language buff - Rust, using Rust itself has already caused the wasm file size to be very small.</p><h2 id=conclusion>Conclusion</h2><p>In this article, we introduced wasm file size optimization solutions from three levels: code level, network level, and physical level, with a total of four solutions.</p><p>Finally, after stacking all the buffs, the current case (accumulated in this series of articles) can reduce the size by <strong>77%</strong>, which really feels great, haha.</p><p>Hope this can be helpful to everyone.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/webassembly/>WebAssembly</a>
<a href=/tags/rust/>Rust</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>Last updated on Oct 27, 2023 00:00 UTC</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/posts/getting-fancy-with-rust-and-webassembly-part-3-rust-and-js-interaction/><div class=article-image><img src=/posts/getting-fancy-with-rust-and-webassembly-part-3-rust-and-js-interaction/cover.2e8b11dfa976d41e74c2f13eba5ef63c_hu11424931117036314226.jpg width=250 height=150 loading=lazy alt="Featured image of post Getting Fancy with Rust and WebAssembly (Part 3) - Rust and JS interaction" data-hash="md5-LosR36l21B50wvE+ul72PA=="></div><div class=article-details><h2 class=article-title>Getting Fancy with Rust and WebAssembly (Part 3) - Rust and JS interaction</h2></div></a></article><article class=has-image><a href=/posts/getting-fancy-with-rust-and-webassembly-part-2-dom-manipulation-and-type-conversion/><div class=article-image><img src=/posts/getting-fancy-with-rust-and-webassembly-part-2-dom-manipulation-and-type-conversion/cover.2e8b11dfa976d41e74c2f13eba5ef63c_hu11424931117036314226.jpg width=250 height=150 loading=lazy alt="Featured image of post Getting Fancy with Rust and WebAssembly (Part 2) - DOM Manipulation and Type Conversion" data-hash="md5-LosR36l21B50wvE+ul72PA=="></div><div class=article-details><h2 class=article-title>Getting Fancy with Rust and WebAssembly (Part 2) - DOM Manipulation and Type Conversion</h2></div></a></article><article class=has-image><a href=/posts/getting-fancy-with-rust-and-webassembly-part-1-quick-start/><div class=article-image><img src=/posts/getting-fancy-with-rust-and-webassembly-part-1-quick-start/cover.2e8b11dfa976d41e74c2f13eba5ef63c_hu11424931117036314226.jpg width=250 height=150 loading=lazy alt="Featured image of post Getting Fancy with Rust and WebAssembly (Part 1) - Quick Start" data-hash="md5-LosR36l21B50wvE+ul72PA=="></div><div class=article-details><h2 class=article-title>Getting Fancy with Rust and WebAssembly (Part 1) - Quick Start</h2></div></a></article><article><a href=/posts/how-to-add-custom-fonts-to-swiftui-project-in-xcode/><div class=article-details><h2 class=article-title>How to add custom fonts to SwiftUI project in Xcode</h2></div></a></article><article><a href=/posts/how-to-make-empty-space-clickable-in-swiftui/><div class=article-details><h2 class=article-title>How to make empty space clickable in SwiftUI</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 Hunter Ji</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>